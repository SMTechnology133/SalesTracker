<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Offline Market sales Tracker</title>
    
    <meta name="theme-color" content="teal"/> 
  
  <link rel="icon" type="image" href="https://smtechnology133.github.io/africaonline/africaOnlineIcon.png"/>
    
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a modern, clean look */
        body {
            font-family: georgia;
            background: linear-gradient(to right, teal, maroon);
            border:1px solid orange;
            border-radius:4px;
            color:orange;
            font-family:georgia;
        }
        
        .app-container {
            max-width: 1000px;
            min-height: 100vh;
        }
        
        .tab-button.active {
            background-color: #48bb78; /* Green-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .card {
        	background: linear-gradient(to right, maroon, teal);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border:1px solid orange;
        }
        
        button{
        	border:1px solid gray;
        	border-radius:6px;
        }
        
        p{
        	font-size:14px;
        	text-decoration:underline;
        }
        
        footer{
        	text-align: center;
        	font-size:10px;
        	border:1px solid orange;
        	border-radius:5px;
        	background:teal;
        }
        
.picturee{
width: 30px;
height: 30px;
border: 1px solid orange;
border-radius: 20px;
padding: 1px;
margin-top: 6px;
}
    </style>
</head>
<body style="margin-top:1px;" class="p-4 sm:p-8">
    <div id="app-container" class="app-container mx-auto">
        <header class="text-center mb-8">
        	
<h1 style="color:orange; font-size:25px; border:1px solid orange; background:teal; border-radius:10px;">
	Local Market Sales Tracking</h1>
           
            <p>Offline-First Inventory & Sales Management</p>

            <!-- Business Name Editor -->
            <div class="mt-2 flex justify-center items-center">
                <span id="business-name-display" class="text-xl font-semibold text-green-600 cursor-pointer" onclick="toggleBusinessNameInput(true)">
                    [Tap to set Business Name]
                </span>
                <div id="business-name-input-group" class="hidden flex items-center space-x-2">
                    <input style="width:200px;" type="text" id="business-name-input" placeholder="Enter Business Name" class="rounded-md border-gray-300 shadow-sm p-2 text-base border focus:ring-green-500 focus:border-green-500 w-64">
                <button style="background:teal;" onclick="saveBusinessName()" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg text-sm transition duration-150">Save</button>
                    <button onclick="toggleBusinessNameInput(false)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 p-2 rounded-lg text-sm transition duration-150">Cancel</button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div style="border:1px solid orange; background:teal;" class="flex flex-wrap justify-center space-x-2 md:space-x-4 mb-8 p-1 bg-black rounded-xl shadow-inner">
        	
            <button style="background:orange; color:teal;" class="tab-button active px-4 py-2 rounded-lg transition duration-150 ease-in-out text-sm md:text-base" data-tab="dashboard">Dashboard</button>
            
            <button style="background:orange; color:teal;" class="tab-button px-4 py-2 rounded-lg transition duration-150 ease-in-out text-sm md:text-base" data-tab="inventory">Inventory</button>
            
            <button style="background:orange; color:teal;" class="tab-button px-4 py-2 rounded-lg transition duration-150 ease-in-out text-sm md:text-base" data-tab="sales">Record Sale</button>
            
            <button style="background:orange; color:teal;" class="tab-button px-4 py-2 rounded-lg transition duration-150 ease-in-out text-sm md:text-base hover:bg-yellow-600" onclick="exportDataToWhatsApp()">Export to WhatsApp</button>
        </div>

        <!-- Tab Content -->
        <div id="dashboard-content" class="tab-content">
            <h2 style="color:orange; font-size:20px; text-align:center;">Summary Dashboard</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card p-6 text-center">
                	
   <p>Total Items in Stock</p>
                    <p id="total-inventory" class="text-4xl font-extrabold text-blue-600 mt-1">0</p>
                </div>
                <div class="card p-6 text-center">
                	
 <p>Sales Value (Today)</p>
                    <p id="daily-sales" class="text-4xl font-extrabold text-green-600 mt-1">MK 0.00</p>
                </div>
                <div class="card p-6 text-center">
  <p >Total Profit Est.</p>
                    <p id="total-profit" class="text-4xl font-extrabold text-red-600 mt-1">MK 0.00</p>
                </div>
            </div>

            <div class="mt-8 card p-6">
                <h3 style="font-size:20px;">Recent Transactions (Today)</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Qty</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                        </tr>
                    </thead>
                    <tbody id="recent-transactions-list" class="bg-white divide-y divide-gray-200">
                        <!-- Transactions will be inserted here -->
                        <tr><td colspan="4" class="text-center py-4">No sales recorded today.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="inventory-content" class="tab-content hidden">
            <h2 class="text-2xl font-bold">Manage Inventory</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Add/Update Form -->
                <div class="lg:col-span-1 card p-6">
                    <h3 class="text-xl font-semibold">Add New Item</h3>
                    <form id="inventory-form" class="space-y-4">
                        <div>
                            <label for="item-name" class="block text-sm font-medium">Item Name</label>
                            <input type="text" id="item-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="unit-cost" class="block text-sm font-medium">Unit Cost (MK)</label>
                                <input type="number" id="unit-cost" required min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="unit-price" class="block text-sm font-medium">Unit Price (MK)</label>
                                <input type="number" id="unit-price" required min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-green-500 focus:border-green-500">
                            </div>
                        </div>
                        <div>
                            <label for="initial-stock" class="block text-sm font-medium">Initial Stock</label>
                            <input type="number" id="initial-stock" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-green-500 focus:border-green-500">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">Add Item
                        </button>
                    </form>
                </div>

                <!-- Inventory List -->
                <div class="lg:col-span-2 card p-6">
                    <h3 class="text-xl font-semibold">Current Stock Levels</h3>          
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Price (MK)</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Stock</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list" class="bg-white divide-y divide-gray-200">
                            <!-- Inventory items will be inserted here -->
                            <tr><td colspan="4" class="text-center py-4 text-gray-500">No inventory items added yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sales-content" class="tab-content hidden">
            <h2 class="text-2xl font-bold">Record a Sale</h2>
            <div class="card p-6 max-w-lg mx-auto">
                <form id="sale-form" class="space-y-4">
                    <div>
                        <label for="sale-item-id" class="block text-sm font-medium">Select Item</label>
                        <select id="sale-item-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-green-500 focus:border-green-500">
                            <option value="">Select an Inventory Item</option>
                        </select>
                    </div>
                    <div>
                        <label for="sale-quantity" class="block text-sm font-medium">Quantity Sold</label>
                        <input type="number" id="sale-quantity" required min="1" value="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-green-500 focus:border-green-500">
                        <p id="current-stock-info" class="text-xs text-gray-500 mt-1"></p>
                    </div>
                    <div>
                        <label for="sale-amount" class="block text-sm font-medium">Total Sale Amount (MK)</label>
                        <input type="number" id="sale-amount" required min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="payment-method" class="block text-sm font-medium">Payment Method</label>
                        <select id="payment-method" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-green-500 focus:border-green-500">
                            <option value="Cash">Cash</option>
                            <option value="Mpamba">TNM Mpamba</option>
                            <option value="Airtel Money">Airtel Money</option>
                            <option value="Card">Card</option>
                            <option value="Credit">Credit</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Finalize Sale
                    </button>
                </form>
            </div>
        </div>

        <!-- System Message Box -->
        <div id="system-message" class="fixed bottom-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0" role="alert">
            <span id="message-content"></span>
        </div>
    </div><br>
    
    	<footer>&copy 2025 Copyright SM Technology</footer>

    <script>
        // --- CONSTANTS AND INITIALIZATION ---
        const DB_NAME = 'MalawiMarketDB';
        const DB_VERSION = 1;
        const INVENTORY_STORE = 'inventory';
        const TRANSACTIONS_STORE = 'transactions';
        const BUSINESS_NAME_KEY = 'businessName';

        let db;
        let inventoryCache = [];

        // --- DEBUG TEST: Checks if script is running ---
        console.log("Tracker Script Loaded. Waiting for DOMContentLoaded.");
        // --- END DEBUG TEST ---

        // --- UTILITY FUNCTIONS ---

        /**
         * Displays a transient system message (error or success).
         * @param {string} message - The message content.
         * @param {string} type - 'success' or 'error'.
         */
        function showMessage(message, type = 'error') {
            const msgBox = document.getElementById('system-message');
            const msgContent = document.getElementById('message-content');

            msgBox.classList.remove('bg-red-500', 'bg-green-500');
            msgBox.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');

            msgContent.textContent = message;
            msgBox.classList.remove('hidden', 'opacity-0');
            msgBox.classList.add('opacity-100');

            setTimeout(() => {
                msgBox.classList.remove('opacity-100');
                msgBox.classList.add('opacity-0');
                setTimeout(() => msgBox.classList.add('hidden'), 300);
            }, 5000);
        }

        // --- INDEXEDDB HANDLERS ---

        /**
         * Initializes and opens the IndexedDB database.
         * @returns {Promise<IDBDatabase>} The database instance.
         */
        function openDatabase() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    const errorMsg = "Browser does not support IndexedDB. Offline storage is unavailable.";
                    showMessage(errorMsg);
                    reject(new Error(errorMsg));
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB: Upgrade needed/Running setup.');

                    if (!db.objectStoreNames.contains(INVENTORY_STORE)) {
                        const store = db.createObjectStore(INVENTORY_STORE, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('name', 'name', { unique: true });
                    }

                    if (!db.objectStoreNames.contains(TRANSACTIONS_STORE)) {
                        const tstore = db.createObjectStore(TRANSACTIONS_STORE, { keyPath: 'id', autoIncrement: true });
                        tstore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB: Database opened successfully.');
                    resolve(db);
                };

                request.onerror = (event) => {
                    const errorMsg = `IndexedDB Error: ${event.target.error?.message || 'Unknown error'}. This usually means a browser security restriction (like running from file://) is blocking it.`;
                    console.error(errorMsg, event.target.error);
                    showMessage(`CRITICAL ERROR: ${errorMsg} Data cannot be saved/loaded. (Check if you are running on GitHub Pages)`, 'error');
                    reject(event.target.error);
                };
            });
        }

        /**
         * Performs a CRUD operation (Add/Put) on an object store.
         */
        function performTransaction(storeName, mode, operation) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("Database not initialized."));
                    return;
                }
                const transaction = db.transaction(storeName, mode);
                const store = transaction.objectStore(storeName);
                const request = operation(store);

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    console.error(`Transaction failed on ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /**
         * Retrieves all records from an object store.
         */
        function getAll(storeName) {
            return performTransaction(storeName, 'readonly', (store) => store.getAll());
        }

        /**
         * Retrieves a single record by ID.
         */
        function getById(storeName, id) {
            return performTransaction(storeName, 'readonly', (store) => store.get(id));
        }

        // --- APPLICATION LOGIC ---

        async function handleInventoryForm(event) {
            event.preventDefault();
            console.log("Inventory form submitted."); // Debug log

            const name = document.getElementById('item-name').value.trim();
            const unitCost = parseFloat(document.getElementById('unit-cost').value);
            const unitPrice = parseFloat(document.getElementById('unit-price').value);
            const initialStock = parseInt(document.getElementById('initial-stock').value);

            if (!name || isNaN(unitCost) || isNaN(unitPrice) || isNaN(initialStock)) {
                showMessage("Please fill out all fields correctly.");
                return;
            }

            const newItem = {
                name,
                unitCost: unitCost.toFixed(2),
                unitPrice: unitPrice.toFixed(2),
                stockQuantity: initialStock,
                lastUpdated: new Date().toISOString()
            };

            try {
                await performTransaction(INVENTORY_STORE, 'readwrite', (store) => store.add(newItem));
                showMessage(`Item "${name}" added successfully.`, 'success');
                document.getElementById('inventory-form').reset();
                await refreshAllData();
            } catch (error) {
                if (error && error.name === 'ConstraintError') {
                    showMessage(`Error: An item named "${name}" already exists. Please choose a unique name.`);
                } else {
                    showMessage('Failed to add item. See console for error details.');
                    console.error('Inventory Add Error:', error);
                }
            }
        }

        async function handleSaleForm(event) {
            event.preventDefault();
            console.log("Sale form submitted."); // Debug log

            const itemId = parseInt(document.getElementById('sale-item-id').value);
            const quantitySold = parseInt(document.getElementById('sale-quantity').value);
            const saleAmount = parseFloat(document.getElementById('sale-amount').value);
            const paymentMethod = document.getElementById('payment-method').value;

            if (isNaN(itemId) || itemId <= 0 || isNaN(quantitySold) || quantitySold <= 0 || isNaN(saleAmount)) {
                showMessage("Please ensure item selection, quantity, and amount are correct.");
                return;
            }

            try {
                const item = await getById(INVENTORY_STORE, itemId);
                if (!item) {
                    showMessage("Selected item not found.");
                    return;
                }

                if (item.stockQuantity < quantitySold) {
                    showMessage(`Insufficient stock! Only ${item.stockQuantity} remaining.`);
                    return;
                }

                // 2. Record the transaction
                const transaction = {
                    itemId,
                    itemName: item.name,
                    quantitySold,
                    saleAmount: saleAmount.toFixed(2),
                    costAmount: (parseFloat(item.unitCost) * quantitySold).toFixed(2),
                    paymentMethod,
                    timestamp: new Date().toISOString()
                };
                await performTransaction(TRANSACTIONS_STORE, 'readwrite', (store) => store.add(transaction));

                // 3. Update the inventory stock
                item.stockQuantity -= quantitySold;
                item.lastUpdated = new Date().toISOString();
                await performTransaction(INVENTORY_STORE, 'readwrite', (store) => store.put(item));

                showMessage(`Sale of ${quantitySold} x ${item.name} recorded!`, 'success');
                document.getElementById('sale-form').reset();
                await refreshAllData();
            } catch (error) {
                showMessage('Failed to record sale. See console for error details.');
                console.error('Sale Error:', error);
            }
        }

        function renderInventoryList(items) {
            const listElement = document.getElementById('inventory-list');
            listElement.innerHTML = '';
            inventoryCache = items;

            if (items.length === 0) {
                listElement.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No inventory items added yet.</td></tr>';
                return;
            }

            items.forEach(item => {
                const row = document.createElement('tr');
                const stockColor = item.stockQuantity < 5 ? 'text-red-500 font-bold' : 'text-green-600';

                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">MK ${parseFloat(item.unitPrice).toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center ${stockColor}">${item.stockQuantity}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteInventoryItem(${item.id})" class="text-red-600 hover:text-red-900 ml-2 transition duration-100">Delete</button>
                    </td>
                `;
                listElement.appendChild(row);
            });
        }

        function renderDashboard(transactions, items) {
            const today = new Date().toISOString().substring(0, 10);
            let dailySalesValue = 0;
            let totalProfitValue = 0;
            let totalStock = 0;

            const todayTransactions = transactions.filter(t => t.timestamp.substring(0, 10) === today);

            transactions.forEach(t => {
                const saleAmount = parseFloat(t.saleAmount || 0);
                const costAmount = parseFloat(t.costAmount || 0);
                totalProfitValue += (saleAmount - costAmount);
                if (t.timestamp.substring(0, 10) === today) {
                    dailySalesValue += saleAmount;
                }
            });

            items.forEach(item => {
                totalStock += Number(item.stockQuantity || 0);
            });

            document.getElementById('total-inventory').textContent = totalStock;
            document.getElementById('daily-sales').textContent = `MK ${dailySalesValue.toFixed(2)}`;
            document.getElementById('total-profit').textContent = `MK ${totalProfitValue.toFixed(2)}`;

            const listElement = document.getElementById('recent-transactions-list');
            listElement.innerHTML = '';

            if (todayTransactions.length === 0) {
                listElement.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No sales recorded today.</td></tr>';
                return;
            }

            todayTransactions.slice(0, 5).forEach(t => {
                const row = document.createElement('tr');
                const saleTime = new Date(t.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${t.itemName}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${t.quantitySold}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-green-600 font-medium">MK ${parseFloat(t.saleAmount).toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${saleTime}</td>
                `;
                listElement.appendChild(row);
            });
        }

        function populateSaleDropdown(items) {
            const select = document.getElementById('sale-item-id');
            const info = document.getElementById('current-stock-info');
            select.innerHTML = '<option value="">-- Select an Inventory Item --</option>';
            info.textContent = 'Stock: N/A';

            const availableItems = items.filter(item => item.stockQuantity > 0);

            availableItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (Stock: ${item.stockQuantity}, Price: MK ${parseFloat(item.unitPrice).toFixed(2)})`;
                select.appendChild(option);
            });

            select.onchange = () => {
                const selectedItem = items.find(item => item.id == select.value);
                const quantityInput = document.getElementById('sale-quantity');
                if (selectedItem) {
                    info.textContent = `Stock: ${selectedItem.stockQuantity} remaining.`;
                    quantityInput.max = selectedItem.stockQuantity;
                    quantityInput.value = 1; // Reset quantity to 1 when item changes
                } else {
                    info.textContent = 'Stock: N/A';
                    quantityInput.max = null;
                    quantityInput.value = 1;
                }
            };
        }

        async function refreshAllData() {
            try {
                const inventory = await getAll(INVENTORY_STORE);
                const transactions = await getAll(TRANSACTIONS_STORE);

                transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                renderInventoryList(inventory);
                populateSaleDropdown(inventory);
                renderDashboard(transactions, inventory);
            } catch (error) {
                // Only show general error if the database wasn't initialized successfully
                if (db) {
                   console.error('Refresh Data Error:', error);
                } else {
                   // Database error should be handled in openDatabase
                   console.warn('Data refresh skipped due to uninitialized DB.');
                }
            }
        }

        // expose deleteInventoryItem as a global function for inline handlers
        window.deleteInventoryItem = async (id) => {
            try {
                await performTransaction(INVENTORY_STORE, 'readwrite', (store) => store.delete(id));
                showMessage("Item deleted successfully.", 'success');
                await refreshAllData();
            } catch (error) {
                showMessage("Failed to delete item.");
                console.error('Delete error:', error);
            }
        };

        window.exportDataToWhatsApp = async () => {
            const businessName = localStorage.getItem(BUSINESS_NAME_KEY) || 'My Local Business';
            showMessage("Preparing report data...", 'success');

            try {
                const transactions = await getAll(TRANSACTIONS_STORE);
                const inventory = await getAll(INVENTORY_STORE);

                const today = new Date();
                const todayStr = today.toLocaleDateString('en-US');

                // 1. Calculate Summary Metrics
                let totalSales = 0;
                let totalProfit = 0;
                let dailySales = 0;
                let dailyProfit = 0;

                transactions.forEach(t => {
                    const sale = parseFloat(t.saleAmount || 0);
                    const cost = parseFloat(t.costAmount || 0);
                    totalProfit += (sale - cost);

                    if (new Date(t.timestamp).toLocaleDateString('en-US') === todayStr) {
                        dailySales += sale;
                        dailyProfit += (sale - cost);
                    }
                    totalSales += sale;
                });

                // 2. Format Inventory Status
                const lowStockItems = inventory
                    .filter(item => item.stockQuantity > 0 && item.stockQuantity < 5)
                    .map(item => `- ${item.name}: ${item.stockQuantity} remaining`)
                    .join('\n');

                const outOfStockItems = inventory
                    .filter(item => item.stockQuantity === 0)
                    .map(item => `- ${item.name}`)
                    .join('\n');

                // 3. Construct the Export Message
                let exportText = `*${businessName} - Business Report (${todayStr})*\n\n`;

                exportText += `--- TODAY'S PERFORMANCE ---\n`;
                exportText += `Total Sales (Today): MK ${dailySales.toFixed(2)}\n`;
                exportText += `Estimated Profit (Today): MK ${dailyProfit.toFixed(2)}\n`;
                exportText += `---------------------------------\n\n`;

                exportText += `--- LIFETIME OVERVIEW ---\n`;
                exportText += `Grand Total Sales: MK ${totalSales.toFixed(2)}\n`;
                exportText += `Grand Total Profit: MK ${totalProfit.toFixed(2)}\n`;
                exportText += `---------------------------------\n\n`;

                const totalItemsInStock = inventory.reduce((sum, item) => sum + Number(item.stockQuantity || 0), 0);
                exportText += `--- INVENTORY ALERT ---\n`;
                exportText += `Total Items in Stock: ${totalItemsInStock}\n\n`;

                if (lowStockItems) {
                    exportText += `*Low Stock (<5 items):*\n${lowStockItems}\n\n`;
                }
                if (outOfStockItems) {
                    exportText += `*Out of Stock:*\n${outOfStockItems}\n\n`;
                }

                exportText += `Report generated by Offline Market Tracker.`;

                // 4. Open WhatsApp Link
                const encodedText = encodeURIComponent(exportText);

                const whatsappUrl = `whatsapp://send?text=${encodedText}`;
                const webWhatsappUrl = `https://web.whatsapp.com/send?text=${encodedText}`;

                // Mobile app vs Desktop/Web fallback
                const finalUrl = navigator.userAgent.match(/android|iphone|ipad|ipod/i) ? whatsappUrl : webWhatsappUrl;
                window.open(finalUrl, '_blank');

                showMessage("Report sharing initiated. Check your WhatsApp app or browser tab.", 'success');
            } catch (e) {
                showMessage("Failed to generate report. Check console.", 'error');
                console.error("WhatsApp Export Error:", e);
            }
        };

        // --- LOCAL STORAGE & UI MANAGEMENT ---

        function toggleBusinessNameInput(show) {
            const display = document.getElementById('business-name-display');
            const inputGroup = document.getElementById('business-name-input-group');
            const input = document.getElementById('business-name-input');

            if (show) {
                display.classList.add('hidden');
                inputGroup.classList.remove('hidden');
                input.value = localStorage.getItem(BUSINESS_NAME_KEY) || '';
                input.focus();
            } else {
                display.classList.remove('hidden');
                inputGroup.classList.add('hidden');
                loadBusinessName(); // Refresh display
            }
        }

        function saveBusinessName() {
            const newName = document.getElementById('business-name-input').value.trim();
            if (newName && newName !== '') {
                localStorage.setItem(BUSINESS_NAME_KEY, newName);
                showMessage("Business name updated!", 'success');
            } else {
                localStorage.removeItem(BUSINESS_NAME_KEY);
                showMessage("Business name cleared or kept default.", 'success');
            }
            toggleBusinessNameInput(false);
        }

        function loadBusinessName() {
            const name = localStorage.getItem(BUSINESS_NAME_KEY);
            const display = document.getElementById('business-name-display');
            if (name) {
                display.textContent = name;
            } else {
                display.textContent = '[Tap to set Business Name]';
            }
        }

        // expose these functions to global scope for inline handlers
        window.toggleBusinessNameInput = toggleBusinessNameInput;
        window.saveBusinessName = saveBusinessName;

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-tab');
                    console.log(`Switching to tab: ${target}`); // Debug log

                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    contents.forEach(content => {
                        if (content.id === `${target}-content`) {
                            content.classList.remove('hidden');
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                });
            });
        }

        /**
         * The main asynchronous initialization function.
         */
        async function initializeApplication() {
            console.log("Initializing Application: Opening Database.");
            try {
                await openDatabase();
                await refreshAllData();
                console.log("Application Initialization Complete.");
            } catch (e) {
                console.error("Critical Application Initialization Failure:", e);
                // The openDatabase function already shows a user message for DB failure.
            }
        }

        // --- ENTRY POINT ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired. Setting up UI and listeners.");

            // 1. Set up UI components (Tabs and Business Name)
            setupTabs();
            loadBusinessName();

            // 2. Set up form submission handlers
            document.getElementById('inventory-form').addEventListener('submit', handleInventoryForm);
            document.getElementById('sale-form').addEventListener('submit', handleSaleForm);

            // 3. Initialize the database and load data
            initializeApplication();
        });

    </script>
</body>
</html>